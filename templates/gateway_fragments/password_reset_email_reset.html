<form th:fragment="form" class="auth-form-terminal"
    th:action="@{/password-reset/email/{resetToken}(resetToken=${resetToken})}"
    method="post"
    th:object="${form}">
    
    <!-- 错误提示 -->
    <div class="terminal-alert mb-4 p-3 border border-red-500 text-red-500 bg-red-500/10 font-mono text-sm" 
        role="alert" th:if="${error}">
        <span class="mr-2 font-bold">[ERROR]</span>
        <strong th:if="${error == 'rate_limit_exceeded'}">请求过于频繁，请稍后再试</strong>
    </div>

    <!-- 密码 (两列布局) -->
    <div class="reset-row">
        <div class="form-item group">
            <label for="password"
                class="block text-xs uppercase tracking-widest text-terminal-dim mb-1 group-focus-within:text-terminal-green transition-colors font-mono">
                新密码
            </label>
            <div class="form-input form-input-stack toggle-password-display-flag relative flex items-center">
                <input type="password" id="password" name="password" required minlength="5" maxlength="257"
                    placeholder="至少5个字符" />
                <div class="form-input-stack-icon toggle-password-btn absolute right-0 cursor-pointer text-terminal-dim hover:text-terminal-green transition-colors"
                    data-target="password">
                    <svg class="password-hidden-icon" style="display: none" viewBox="0 0 24 24" width="1.2em" height="1.2em">
                        <path fill="currentColor" d="M12 3c5.392 0 9.878 3.88 10.819 9c-.94 5.12-5.427 9-10.819 9c-5.392 0-9.878-3.88-10.818-9C2.122 6.88 6.608 3 12 3Zm0 16a9.005 9.005 0 0 0 8.778-7a9.005 9.005 0 0 0-17.555 0A9.005 9.005 0 0 0 12 19Zm0-2.5a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9Zm0-2a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5Z"></path>
                    </svg>
                    <svg class="password-display-icon" viewBox="0 0 24 24" width="1.2em" height="1.2em">
                        <path fill="currentColor" d="M17.883 19.297A10.949 10.949 0 0 1 12 21c-5.392 0-9.878-3.88-10.818-9A10.982 10.982 0 0 1 4.52 5.935L1.394 2.808l1.414-1.414l19.799 19.798l-1.414 1.415l-3.31-3.31ZM5.936 7.35A8.965 8.965 0 0 0 3.223 12a9.005 9.005 0 0 0 13.201 5.838l-2.028-2.028A4.5 4.5 0 0 1 8.19 9.604L5.936 7.35Zm6.978 6.978l-3.242-3.241a2.5 2.5 0 0 0 3.241 3.241Zm7.893 2.265l-1.431-1.431A8.935 8.935 0 0 0 20.778 12A9.005 9.005 0 0 0 9.552 5.338L7.974 3.76C9.221 3.27 10.58 3 12 3c5.392 0 9.878 3.88 10.819 9a10.947 10.947 0 0 1-2.012 4.593Zm-9.084-9.084a4.5 4.5 0 0 1 4.769 4.769l-4.77-4.77Z"></path>
                    </svg>
                </div>
            </div>
            <p class="text-red-500 text-xs mt-1 font-mono" role="alert" 
                th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></p>
        </div>
        <div class="form-item group">
            <label for="confirmPassword"
                class="block text-xs uppercase tracking-widest text-terminal-dim mb-1 group-focus-within:text-terminal-green transition-colors font-mono">
                确认密码
            </label>
            <div class="form-input form-input-stack toggle-password-display-flag relative flex items-center">
                <input type="password" id="confirmPassword" name="confirmPassword" required minlength="5" maxlength="257"
                    placeholder="再次输入密码" />
                <div class="form-input-stack-icon toggle-password-btn absolute right-0 cursor-pointer text-terminal-dim hover:text-terminal-green transition-colors"
                    data-target="confirmPassword">
                    <svg class="password-hidden-icon" style="display: none" viewBox="0 0 24 24" width="1.2em" height="1.2em">
                        <path fill="currentColor" d="M12 3c5.392 0 9.878 3.88 10.819 9c-.94 5.12-5.427 9-10.819 9c-5.392 0-9.878-3.88-10.818-9C2.122 6.88 6.608 3 12 3Zm0 16a9.005 9.005 0 0 0 8.778-7a9.005 9.005 0 0 0-17.555 0A9.005 9.005 0 0 0 12 19Zm0-2.5a4.5 4.5 0 1 1 0-9a4.5 4.5 0 0 1 0 9Zm0-2a2.5 2.5 0 1 0 0-5a2.5 2.5 0 0 0 0 5Z"></path>
                    </svg>
                    <svg class="password-display-icon" viewBox="0 0 24 24" width="1.2em" height="1.2em">
                        <path fill="currentColor" d="M17.883 19.297A10.949 10.949 0 0 1 12 21c-5.392 0-9.878-3.88-10.818-9A10.982 10.982 0 0 1 4.52 5.935L1.394 2.808l1.414-1.414l19.799 19.798l-1.414 1.415l-3.31-3.31ZM5.936 7.35A8.965 8.965 0 0 0 3.223 12a9.005 9.005 0 0 0 13.201 5.838l-2.028-2.028A4.5 4.5 0 0 1 8.19 9.604L5.936 7.35Zm6.978 6.978l-3.242-3.241a2.5 2.5 0 0 0 3.241 3.241Zm7.893 2.265l-1.431-1.431A8.935 8.935 0 0 0 20.778 12A9.005 9.005 0 0 0 9.552 5.338L7.974 3.76C9.221 3.27 10.58 3 12 3c5.392 0 9.878 3.88 10.819 9a10.947 10.947 0 0 1-2.012 4.593Zm-9.084-9.084a4.5 4.5 0 0 1 4.769 4.769l-4.77-4.77Z"></path>
                    </svg>
                </div>
            </div>
            <p class="text-red-500 text-xs mt-1 font-mono" role="alert" 
                th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}"></p>
        </div>
    </div>

    <!-- Altcha Captcha -->
    <div halo:captcha class="form-item-compact w-full my-4"></div>

    <!-- Submit Button -->
    <div class="form-item mt-6">
        <button type="submit"
            class="group relative w-full py-3 px-4 border-2 border-terminal-green text-terminal-green font-bold uppercase tracking-widest hover:bg-terminal-green hover:text-black transition-all overflow-hidden flex items-center justify-center">
            <span class="relative z-10 flex items-center justify-center gap-2 font-mono">
                <span>重置密码</span>
                <span class="group-hover:translate-x-1 transition-transform">-&gt;</span>
            </span>
        </button>
    </div>

    <style>
        .reset-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }
        @media (max-width: 480px) {
            .reset-row {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll('.toggle-password-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const input = document.getElementById(targetId);
                    const hiddenIcon = this.querySelector('.password-hidden-icon');
                    const displayIcon = this.querySelector('.password-display-icon');
                    
                    if (input.type === 'password') {
                        input.type = 'text';
                        hiddenIcon.style.display = 'block';
                        displayIcon.style.display = 'none';
                    } else {
                        input.type = 'password';
                        hiddenIcon.style.display = 'none';
                        displayIcon.style.display = 'block';
                    }
                });
            });

            if (typeof setupPasswordConfirmation === 'function') {
                setupPasswordConfirmation("password", "confirmPassword");
            }
        });
    </script>
</form>
